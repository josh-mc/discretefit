---
title: "Random Contingecy Tables with Fixed Margins"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{random_contingecy_tables_with_fixed_margins}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(discretefit)

plot_speed <- function(rsums, csums, title)  {
  
  speed <- bench::mark(min_iterations = 20, 
                       check = FALSE,
                       rcont_cpp = rcont_cpp(1000, csums, rsums),
                       rcont_cpp2 = rcont_cpp2(1000, csums, rsums),
                       rcont_j = rcont_j(1000, csums, rsums),
                       rcont_jp = rcont_j_par(1000, csums, rsums),
                       rcont_jp_cg = rcont_j_par_pcg(1000, csums, rsums),
                       rcont3_cpp = rcont3_cpp(1000, csums, rsums, seed = 1203),
                       rcont_r = rcont_r(1000, csums, rsums),
                       rcont_r2 = rcont_r2(1000, csums, rsums),
                       rcont2 = r2dtable(1000, rsums, csums),
                       rcont = RCONT(1000, rsums, csums)
                       )

  ggplot2::autoplot(speed) +
    ggplot2::theme_minimal() +
    ggplot2::xlab(NULL) +
    ggplot2::ylab(NULL) +
    ggplot2::ggtitle(title)

}
```





The following comparisons between RCONT (Boyett, 1979) and RCONT2 (Patefield, 1981) are taken given by Patefield (1981).

```{r}

rsums <- c(5, 5)
csums <- c(rep(1, 4), 2, 2, 2)

plot_speed(rsums, csums, title = "2 x 7, n = 10")

```


```{r}

rsums <- c(50, 50)
csums <- c(rep(14, 5), 15, 15)

plot_speed(rsums, csums, title = "2 x 7, n = 100")

```

2 x 7, n = 1000

```{r}

#rsums <- c(500, 500)
#csums <- c(rep(140, 5), 150, 150)

csums <- c(500, 500)
rsums <- c(rep(140, 5), 150, 150)

plot_speed(rsums, csums, title = "2 x 7, n = 1000")

```




```{r}

rsums <- c(2, 2, 3, 3)
csums <- c(2, 2, 3, 3)


plot_speed(rsums, csums, title = "4 x 4, n = 10")

```


```{r}

rsums <- c(rep(25, 4))
csums <- c(rep(25, 4))


plot_speed(rsums, csums, title = "4 x 4, n = 100")

```



```{r}

rsums <- c(rep(250, 4))
csums <- c(rep(250, 4))


plot_speed(rsums, csums, title = "4 x 4, n = 1000")

```
```{r}

rsums <- c(rep(2500, 4))
csums <- c(rep(2500, 4))


plot_speed(rsums, csums, title = "4 x 4, n = 10,000")

```




```{r}

rsums <- c(2, 2, 2, 2, 2)
csums <- c(2, 2, 2, 2, 2)


plot_speed(rsums, csums, title = "5 x 5, n = 10")

```


```{r}

rsums <- c(rep(20, 5))
csums <- c(rep(20, 5))


plot_speed(rsums, csums, title = "5 x 5, n = 100")

```

```{r}

rsums <- c(rep(200, 5))
csums <- c(rep(200, 5))


plot_speed(rsums, csums, title = "5 x 5, n = 1000")

```




6 x 6, n = 10

```{r}

rsums <- c(1, 1, 2, 2, 2, 2)
csums <- c(1, 1, 2, 2, 2, 2)


plot_speed(rsums, csums, title = "6 x 6, n = 10")

```


```{r}

rsums <- c(17, 17, 17, 17, 16, 16)
csums <- c(17, 17, 17, 17, 16, 16)


plot_speed(rsums, csums, title = "6 x 6, n = 100")

```


```{r}

rsums <- c(170, 170, 170, 170, 160, 160)
csums <- c(170, 170, 170, 170, 160, 160)


plot_speed(rsums, csums, title = "6 x 6, n = 1000")

```

6 x 6, n = 10000

```{r}

rsums <- c(1700, 1700, 1700, 1700, 1600, 1600)
csums <- c(1700, 1700, 1700, 1700, 1600, 1600)

plot_speed(rsums, csums, title = "6 x 6, n = 10,000")

```

## Sparse

```{r}

rsums <- c(rep(5, 100))
csums <- c(rep(5, 100))

plot_speed(rsums, csums, title = "100 x 100, n = 500")

```



```{r}

rsums <- c(rep(20, 100))
csums <- c(rep(20, 100))

plot_speed(rsums, csums, title = "100 x 100, n = 2000")

```


```{r}

rsums <- c(rep(20, 100))
csums <- c(rep(2, 1000))

speed <- bench::mark(min_iterations = 20, check = FALSE, 
 rcont_cpp = rcont_cpp(1000, rsums, csums),                    
 rcont2 = r2dtable(1000, rsums, csums)
)

ggplot2::autoplot(speed) +
  ggplot2::theme_minimal() +
  ggplot2::xlab(NULL) +
  ggplot2::ylab(NULL) +
  ggplot2::ggtitle("100 x 100, n = 2000")

```


```{r}

rsums <- c(rep(2, 1000))
csums <- c(rep(20, 100))


speed <- bench::mark(min_iterations = 20, check = FALSE, 
 rcont = rcont_cpp(1000, rsums, csums),                    
 rcont2 = r2dtable(1000, rsums, csums)
)

ggplot2::autoplot(speed) +
  ggplot2::theme_minimal() +
  ggplot2::xlab(NULL) +
  ggplot2::ylab(NULL) +
  ggplot2::ggtitle("2 x 20, n = 2000")

```


```{r}
rsums <- c(rep(2, 1000))
csums <- c(rep(20, 100))


speed <- bench::mark(min_iterations = 20, check = FALSE, 
 rcont = rcont_cpp(1000, rsums, csums),
 flipped_rcont = rcont_cpp(1000, csums, rsums)
)

ggplot2::autoplot(speed) +
  ggplot2::theme_minimal() +
  ggplot2::xlab(NULL) +
  ggplot2::ylab(NULL) +
  ggplot2::ggtitle("2 x 20, n = 2000")
```

## Examples

Example cited here: file:///C:/Users/Josh/Documents/fabricated%20-%20files/Contingency%20Tables/On%20uniform%20generation%20of%20two-way%20tables%20with%20fixed%20margins%20and%20the%20conditional%20volume%20test%20of%20Diaconis%20and%20Efron.pdf

Table 1

```{r}

mat <- matrix(c(1, 1, 5, 1, 5, 6, 7, 9, 3, 6, 1, 2, 3, 4, 1, 1),
              ncol = 4)

rsums <- rowSums(mat)
csums <- colSums(mat)

plot_speed(rsums, csums, title = "Table 1 example")
```

Table 3

```{r}

mat <- matrix(c(10, 3, 5, 1, 5, 0, 6, 0, 1),
              ncol = 3)

rsums <- rowSums(mat)
csums <- colSums(mat)

plot_speed(rsums, csums, title = "Table 3 example")
```

Table 4


```{r}

mat <- matrix(c(1, 1, 4, 4, 9, 6, 2, 3, 3, 5, 1, 0),
              ncol = 4)

rsums <- rowSums(mat)
csums <- colSums(mat)

plot_speed(rsums, csums, title = "Table 4 example")
```





```{r}

rsums <- c(220, 215, 93, 64)
csums <- c(108, 286, 71, 127)

plot_speed(rsums, csums, title = "4 x 4 example")
```

```{r}

rsums <- c(220, 215, 93, 64) * 5
csums <- c(108, 286, 71, 127) * 5


plot_speed(rsums, csums, title = "4 x 4 example")
```
```{r}
mat <- matrix(c(68, 20, 15, 5,
                119, 84, 54, 29,
                26, 17, 14, 14,
                7, 94, 10, 16,
                220, 215, 93, 64),
                ncol = 4)

chisq.test(mat, simulate.p.value = TRUE, B = 10000)
```

Toy example

```{r}

rsums <- c(3, 6, 12, 8, 12, 3, 12, 10, 3, 7, 21, 5, 24, 41, 71)
csums <- c(123, 115)

plot_speed(rsums, csums, title = "15 x 2 example")

```

 
## Accuracy

Visual checks.

```{r}

n <- 100000

#rsums <- c(rep(100, 10))
#csums <- c(rep(100, 10))

rsums <- c(rep(20, 20))
csums <- c(rep(20, 20))

x <- rcont_j_par_pcg(n, rsums, csums)
 
e <- c(rep(10, 100))
p_vec <- numeric(100)
chisq_vec <- numeric(100)

for(i in 1:n) {
  
  o <- x[i][[1]]
  
  chisq <- sum((o - e)**2 / e)
  p <- pchisq(chisq, df = 81, lower.tail = FALSE)
  
  
  chisq_vec[i] <- chisq
  p_vec[i] <- p 
  
}


hist(chisq_vec)
hist(p_vec)


```

Same for r2dtables

```{r}

n <- 1000

#rsums <- c(rep(100, 10))
#csums <- c(rep(100, 10))

rsums <- c(rep(20, 20))
csums <- c(rep(20, 20))
x <- r2dtable(n, rsums, csums)
 
e <- c(rep(10, 100))
p_vec <- numeric(100)
chisq_vec <- numeric(100)

for(i in 1:n) {
  
  o <- x[i][[1]]
  
  chisq <- sum((o - e)**2 / e)
  p <- pchisq(chisq, df = 81, lower.tail = FALSE)
  
  
  chisq_vec[i] <- chisq
  p_vec[i] <- p 
  
}


hist(chisq_vec)
hist(p_vec)


```


Comparison to r2dtables

```{r}

n <- 10000

r_sums <- c(rep(3, 4))
c_sums <- c(rep(3, 4))
  
#For e 

e <- outer(r_sums, c_sums, "*") / sum(r_sums)

rcont_chi <- numeric(n)
r2d_chi <- numeric(n)

for(i in 1:n)  {
    
    x <- rcont_cpp(1, r_sums, c_sums)
    o <- x[1][[1]]
    rcont <- sum((o - e)**2 / e)
  
    rcont_chi[i] <- rcont

    y <- r2dtable(1, r_sums, c_sums)
    oo <- y[1][[1]]
    r2d <- sum((oo - e)**2 / e)
    
    r2d_chi[i] <- r2d
    
}

#Testing the hypothesis that these are both from the same distributions.

ks.test(rcont_chi, r2d_chi)
chisq.test(rcont_chi, r2d_chi)

```

